---
title: "DWLGRE003 Reproducible Research Deliverable"
author: "Grethen de Waal"
date: "`r Sys.Date()`"
output: html_document
---

<br>

### Introduction

The dataset I have selected shows the number of TB cases per 100,000 for each age group, divided by sex, for 201 countries in the year 2000. 

This data were taken from a [Udemy R course](https://www.udemy.com/course/r-programming-for-statistics-and-data-science/) I did, and was originally sourced from WHO, likely [this report](https://iris.who.int/server/api/core/bitstreams/75cba848-3a89-4e05-a736-afb69d0bece5/content).

<br>

### Tidying the data

To tidy the data, I used the tidyverse, ggplot2 and countrycode packages.

<br>

#### Loading the packages

```{r}
library(tidyverse)
library(ggplot2)
library(countrycode)
```

<br>

#### Loading the data

```{r}
tb <- read_csv("data/tb_untidy.csv") 

tb <- as_tibble(tb)

tb
```

<br>

#### Identifying the problems

There are **five key problems** with the data:

1. There are many NA entries - can remove these with pivot_longer().

2. Column with sex and age needs split and be made into observations.

3. The age groups need to be split with a hyphen using mutate().

4. Country codes should have names.

5. The "year" column is unnecessary because it is the same for each entry.

<br>

#### Running the code

**Problems 1 and 2** were dealt with simultaneously:

Remove the NA observations, shift the age and sex columns (e.g. m014, m1524, etc.) into observations and split them across two separate columns.

<br>
```{r}
tb_tidy <- tb %>%
  pivot_longer(                  # reshapes data from wide to long format
    cols = m04:fu,               # tells R which columns to move
    names_to = c("sex", "age"),  # tells R what to name the new columns
    names_pattern = "(.)(.*)",   # tells R how to split the first letter from everything that follows
    values_to = "cases",         # tells R where to put the observations from the columns we shifted
    values_drop_na = TRUE        # gets rid of "NA" observations
    )
```

<br>

**Problem 3**

The age ranges need to be split. 

With this code below, entries like "014" are split with a hyphen, and will end up looking like "0-14". Since 65 does not come with an age range, I just said "65+".

<br>

```{r}
tb_tidy <- tb_tidy %>%
  mutate(age = case_when(
    age == "014" ~ "0-14",
    age == "1524" ~ "15-24",
    age == "2534" ~ "25-34",
    age == "3544" ~ "35-44",
    age == "4554" ~ "45-54",
    age == "5564" ~ "55-64",
    age == "65"   ~ "65+",
    TRUE ~ age                  # this keeps everything else as is
  ))
```

<br>

**Problem 4**

The country codes need to have names.

<br>

```{r}
# Extract country names from country codes
# use iso2c: ISO-2 character

# Insert country names in new column
tb_tidy <- tb_tidy %>%
  mutate(country_name = countrycode(country, origin = "iso2c", destination = "country.name"))

# Reorder columns
tb_tidy <- tb_tidy %>%
  relocate(country, country_name) 

tb_tidy
```

<br>

Country code AN does not exist in the countrycode package (Warning message: "Some values were not matched unambiguously: AN"). 

I tried using the mutate() function the way I used it to add the hyphens in the age ranges but it didn't work, so I kept both the country codes and the names. For the sake of brevity, I did not include the code in this file, but it is available in tb_tidying.R.

<br>

**Problem 5**
Removing the year column.
<br>

```{r}
tb_tidied <- tb_tidy %>% 
  select(-year)
```

<br>

### Export tidied dataset

```{r}
write.csv(tb_tidied, file = "data/tb_tidied.csv", row.names = FALSE)
```

<br>

### Creating charts

Because the number of cases is a continuous variable and the sex is discrete, I converted the data into a box plot and a bar chart.

<br>

```{r}
# box plot
tidy_box <- ggplot(tb_tidy, aes(x = age, y = cases, fill = sex)) +
  geom_boxplot(position = "dodge") +
  theme_minimal() +
  scale_fill_brewer(palette = "Paired") +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) +
  labs(x = "Age Group", 
        y = "Number of Cases",
        fill = "Sex")

tidy_box
```

<br>

**Figure 1:** A box plot of TB cases by age and sex, per country, in the year 2000.

<br>

The box plot shows the overall spread of data well, but it's very difficult to see the interquartile range.

<br>

```{r}
# bar chart
 tb_summary <- tb_tidy %>%
   group_by(age, sex) %>%
   summarise(
     mean_cases = mean(cases, na.rm = TRUE),
     se_cases = sd(cases, na.rm = TRUE) / sqrt(n()), 
     .groups = "drop") 
 
 
tidy_bar <- ggplot(tb_summary, aes(x = age, y = mean_cases, fill = sex)) +
  geom_col(position = "dodge") +
  geom_errorbar(
    aes(ymin = mean_cases - se_cases, ymax = mean_cases + se_cases),
    position = position_dodge(width = 0.9),
    width = 0.25) +
  scale_fill_brewer(palette = "Paired") +
   theme_minimal() +  
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) +
  labs(x = "Age Group", 
       y = "Number of Cases",
       fill = "Sex") 

tidy_bar
```
<br>

**Figure 2:** A bar chart of TB cases by age and sex, per country, in the year 2000.

<br> 





